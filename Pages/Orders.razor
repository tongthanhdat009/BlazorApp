@page "/orders"
@layout CustomerLayout
@using BlazorApp.Services
@using BlazorApp.Dto
@using BlazorApp.Services.Interface
@using Microsoft.JSInterop
@inject IOrderService OrderService
@inject IS3ImageService S3ImageService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="orders-container">
    <div class="orders-header">
        <h1>
            <i class="bi bi-receipt me-3"></i>
            Đơn hàng của bạn
        </h1>
        <div class="filters-section">
            <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" 
                    placeholder="Tìm kiếm mã đơn hàng..." 
                    @bind="searchKeyword" 
                    @bind:event="oninput"
                    @onkeyup="OnSearchKeyup" />
            </div>
            <div class="category-section">
                <button class="filter-btn @(string.IsNullOrEmpty(selectedCategoryName) ? "active" : "")" 
                    @onclick='() => FilterByCategory(null)'>
                    Tất cả
                </button>

                <button class="filter-btn @(selectedCategoryName == "pending" ? "active" : "")"
                    @onclick='() => FilterByCategory("pending")'>
                    Chờ xác nhận
                </button>

                <button class="filter-btn @(selectedCategoryName == "approved" ? "active" : "")"
                    @onclick='() => FilterByCategory("approved")'>
                    Đã duyệt
                </button>

                <button class="filter-btn @(selectedCategoryName == "processing" ? "active" : "")"
                    @onclick='() => FilterByCategory("processing")'>
                    Đang xử lý
                </button>

                <button class="filter-btn @(selectedCategoryName == "shipping" ? "active" : "")"
                    @onclick='() => FilterByCategory("shipping")'>
                    Đang giao hàng
                </button>

                <button class="filter-btn @(selectedCategoryName == "delivered" ? "active" : "")"
                    @onclick='() => FilterByCategory("delivered")'>
                    Đã giao hàng
                </button>

                <button class="filter-btn @(selectedCategoryName == "completed" ? "active" : "")"
                    @onclick='() => FilterByCategory("completed")'>
                    Hoàn thành
                </button>

                <button class="filter-btn @(selectedCategoryName == "canceled" ? "active" : "")"
                    @onclick='() => FilterByCategory("canceled")'>
                    Đã hủy
                </button>

                <button class="filter-btn @(selectedCategoryName == "refund" ? "active" : "")"
                    @onclick='() => FilterByCategory("refund")'>
                    Đang chờ hoàn tiền
                </button>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Đang tải đơn hàng...</p>
        </div>
    }
    else if (filteredOrders.Count == 0)
    {
        <div class="empty-orders">
            <div class="empty-icon">
                <i class="bi bi-receipt-cutoff"></i>
            </div>
            <h3>Chưa có đơn hàng nào</h3>
            <p class="text-muted">Bạn chưa có đơn hàng nào. Hãy bắt đầu mua sắm ngay!</p>
            <a href="/products" class="btn btn-success btn-lg">
                <i class="bi bi-grid-3x3-gap-fill me-2"></i>
                Mua sắm ngay
            </a>
        </div>
    }
    else 
    {
        <div class="orders-body">
            @foreach (var order in filteredOrders)
            {
                <div class="orders-item">
                    <div class="header">
                        <span class="order-code">
                            MÃ ĐƠN HÀNG: @order.OrderId
                        </span>
                        <span class="order-status">
                            
                            @switch (order.OrderStatus?.ToLower())
                            {
                                case "pending":
                                    @:<text class="badge pending">CHỜ XÁC NHẬN</text>
                                    break;
                                case "approved":
                                    @:<text class="badge approved">ĐÃ DUYỆT</text>
                                    break;
                                case "processing":
                                    @:<text class="badge processing">ĐANG XỬ LÝ</text>
                                    break;
                                case "shipping":
                                    @:<text class="badge shipping">ĐANG GIAO HÀNG</text>
                                    break;
                                case "delivered":
                                    @:<text class="badge delivered">ĐÃ GIAO HÀNG</text>
                                    break;
                                case "completed":
                                    @:<text class="badge completed">HOÀN THÀNH</text>
                                    break;
                                case "paid":
                                    @:<text class="badge paid">HOÀN THÀNH</text>
                                    break;
                                case "canceled":
                                    @if (order.HasPendingRefund && order.RefundStatus == "pending")
                                    {
                                        @:<text class="badge refund-pending">ĐANG CHỜ DUYỆT HOÀN TIỀN</text>
                                    }
                                    else if (order.RefundStatus == "approved")
                                    {
                                        @:<text class="badge refund-approved">ĐANG XỬ LÝ HOÀN TIỀN</text>
                                    }
                                    else if (order.RefundStatus == "completed")
                                    {
                                        @:<text class="badge refund-completed">ĐÃ HOÀN TIỀN</text>
                                    }
                                    else
                                    {
                                        @:<text class="badge canceled">ĐÃ HỦY</text>
                                    }
                                    break;

                                default:
                                    @:<text>KHÔNG XÁC ĐỊNH</text>
                                    break;
                            }
                        </span>
                    </div>

                    <div class="order-info">
                        <div class="info-item">
                            <i class="bi bi-calendar-event"></i>
                            <span>Ngày đặt: @order.OrderDate?.ToString("dd/MM/yyyy HH:mm")</span>
                        </div>
                        <div class="info-item">
                            <i class="bi bi-credit-card"></i>
                            <span>
                                Thanh toán: 
                                @switch (order.PaymentMethod?.ToLower())
                                {
                                    case "cash":
                                        <text>Tiền mặt</text>
                                        break;
                                    case "card":
                                        <text>Thẻ</text>
                                        break;
                                    case "bank_transfer":
                                        <text>Chuyển khoản</text>
                                        break;
                                    case "e-wallet":
                                        <text>Ví điện tử</text>
                                        break;
                                    default:
                                        <text>@order.PaymentMethod</text>
                                        break;
                                }
                            </span>
                        </div>
                    </div>

                    <div class="body">
                        @{
                            bool isExpanded = expandOrderItems.ContainsKey(order.OrderId)
                                            && expandOrderItems[order.OrderId];

                            var displayItems = isExpanded
                                ? order.OrderItems
                                : order.OrderItems.Take(2);
                        }

                        @foreach (var item in displayItems)
                        {
                            <div class="order-item">
                                <div class="item-image">
                                    @if (item.ProductId.HasValue && productImageUrls.ContainsKey(item.ProductId.Value))
                                    {
                                        <img src="@productImageUrls[item.ProductId.Value]" 
                                             alt="@item.ProductName" 
                                             style="width: 100%; height: 100%; object-fit: cover;" />
                                    }
                                    else
                                    {
                                        <div class="no-image">
                                            <i class="bi bi-image"></i>
                                        </div>
                                    }
                                </div>

                                <div class="item-info">
                                    <span class="title">@item.ProductName</span>
                                    <span class="quantity">x @item.Quantity</span>
                                </div>

                                <div class="item-amount">
                                    @item.Subtotal đ
                                </div>
                            </div>
                        }

                        <!-- NÚT HIỆN / THU GỌN -->
                        @if (order.OrderItems.Count > 2)
                        {
                            <button class="show-more-btn"
                                    @onclick="() => ToggleExpand(order.OrderId)">
                                @(isExpanded
                                    ? "Thu gọn"
                                    : $"Hiện tất cả ({order.OrderItems.Count} sản phẩm)")
                            </button>
                        }
                    </div>


                    <div class="footer">
                        <div class="order-total-amount">
                            Thành tiền: 
                            <span class="total-amount">
                                @(order.TotalAmount - order.DiscountAmount)
                            </span>
                        </div>
                        <div class="order-btn">
                            @{
                                // Kiểm tra xem có phải là trạng thái không được hủy không
                                var nonCancelableStatuses = new[] { "approved", "processing", "shipping", "delivered", "completed" };
                                bool canCancel = (order.PayStatus == "pending" || order.PayStatus == "paid")
                                    && order.OrderType?.ToLower() == "online"
                                    && !nonCancelableStatuses.Contains(order.OrderStatus?.ToLower());
                            }
                            
                            @if(canCancel)
                            {
                                <button class="order-btn-cancel" @onclick="() => OpenConfirm(order)">
                                    Hủy đơn
                                </button>
                            }
                            
                            <button class="order-btn-detail" 
                                @onclick="() => OpenOrderDetail(order)"
                            >
                                Xem chi tiết
                            </button>
                        </div>
                    </div>

                </div>
            }
        </div>
    }

    <!-- MODAL XEM CHI TIẾT ĐƠN HÀNG -->
    @if (isShowDetailModal && selectedOrder != null)
    {
        <div class="modal-backdrop-custom" @onclick="CloseOrderDetail"></div>

        <div class="order-detail-modal">
            <div class="modal-header">
                    <span 
                        style="
                            font-size: 20px;
                            font-weight: bold;
                        "
                    >
                        Chi tiết đơn hàng #@selectedOrder.OrderId
                    </span>
                    <span
                        style="
                            font-size: 15px;
                            color: #757575;
                        "
                    >
                        Yêu cầu vào: @selectedOrder.OrderDate
                        &nbsp;&nbsp;|
                        <span style="color: #27ae60; padding-left: 10px;">
                            
                            @switch (selectedOrder.PayStatus?.ToLower())
                            {
                                case "pending":
                                    @:<text class="badge pending">CHỜ XÁC NHẬN</text>
                                    break;

                                case "paid":
                                    @:<text class="badge paid">HOÀN THÀNH</text>
                                    break;

                                case "canceled":
                                    @:<text class="badge canceled">ĐÃ HỦY</text>
                                    break;
                                    
                                case "refunded":
                                    @if (selectedOrder.HasPendingRefund && selectedOrder.RefundStatus == "pending")
                                    {
                                        @:<text class="badge refund-pending">ĐANG CHỜ DUYỆT HOÀN TIỀN</text>
                                    }
                                    else if (selectedOrder.RefundStatus == "approved")
                                    {
                                        @:<text class="badge refund-approved">ĐANG XỬ LÝ HOÀN TIỀN</text>
                                    }
                                    else if (selectedOrder.RefundStatus == "completed")
                                    {
                                        @:<text class="badge refund-completed">ĐÃ HOÀN TIỀN</text>
                                    }
                                    else
                                    {
                                        @:<text class="badge refund-completed">ĐÃ HOÀN TIỀN</text>
                                    }
                                    break;

                                default:
                                    @:<text>KHÔNG XÁC ĐỊNH</text>
                                    break;
                            }
                        </span>
                    </span>
                    
            </div>

            <div class="modal-body">
                <div class="modal-info-detail airmail-border">
                    <h3 style="text-align: center; font-weight: 500; margin-bottom: 10px;">Thông tin giao hàng</h3>
                    <div class="detail">
                        @if (selectedOrder != null)
                        {
                                <div style="display: flex; justify-content: space-between; gap: 20px; padding-bottom: 10px; border-bottom: 1px solid rgba(117, 117, 117, 0.3); margin-bottom: 10px;">
                                    <span style="font-weight: 600;">Họ tên:</span>
                                    <span>@(selectedOrder.Name ?? "Chưa có thông tin")</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; gap: 20px; padding-bottom: 10px; border-bottom: 1px solid rgba(117, 117, 117, 0.3); margin-bottom: 10px;">
                                    <span style="font-weight: 600;">Số điện thoại:</span>
                                    <span>@(selectedOrder.Phone ?? "Chưa có thông tin")</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; gap: 20px; padding-bottom: 10px; border-bottom: 1px solid rgba(117, 117, 117, 0.3); margin-bottom: 10px;">
                                    <span style="font-weight: 600;">Email:</span>
                                    <span>@(selectedOrder.Email ?? "Chưa có thông tin")</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; gap: 20px; padding-bottom: 10px; border-bottom: 1px solid rgba(117, 117, 117, 0.3); margin-bottom: 10px;">
                                    <span style="font-weight: 600;">Địa chỉ:</span>
                                    <span>@(selectedOrder.Address ?? "Chưa có thông tin")</span>
                                </div>
                        }
                    </div>
                </div>
                <table class="modal-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Sản phẩm</th>
                            <th>Số lượng</th>
                            <th>Đơn giá</th>
                            <th>Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int stt = 1;
                        }
                        @foreach (var item in selectedOrder.OrderItems)
                        {
                            <tr>
                                <td>@stt</td>
                                <td>@item.ProductName</td>
                                <td>x @item.Quantity</td>
                                <td>@item.Price đ</td>
                                <td>@item.Subtotal đ</td>
                            </tr>
                            stt++;
                        }
                    </tbody>
                </table>
                <div class="modal-final-amount">
                    <div class="detail-amount">
                        <div style="display: flex; justify-content: space-between; gap: 90px">
                            <span>Tổng tiền:</span>
                            <span>@selectedOrder.TotalAmount đ</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; gap: 90px; padding-bottom: 10px; border-bottom: 1px solid #757575;">
                            <span>Giảm giá:</span>
                            <span>-@selectedOrder.DiscountAmount đ</span>
                        </div>
                    </div>
                    <div class="final-amount">
                        <div style="display: flex; justify-content: space-between; font-size: 18px; padding-top: 10px; gap: 60px;">
                            <span>Thành tiền:</span>
                            <span style="color: #27ae60; font-weight: 600;">@(selectedOrder.TotalAmount - selectedOrder.DiscountAmount) đ</span>
                        </div>
                    </div>
                </div>
            </div>
    

            <div class="modal-footer">
                <button class="order-btn-pdf" @onclick="() => DownloadPdf(selectedOrder.OrderId)" disabled="@isDownloadingPdf">
                    <i class="bi bi-file-pdf"></i>
                    @(isDownloadingPdf ? "Đang tạo PDF..." : "Tải hóa đơn PDF")
                </button>
                
                <button class="order-btn-detail" @onclick="CloseOrderDetail">
                    Đóng
                </button>
            </div>
        </div>
    }

    <!-- MODAL HỦY ĐƠN HÀNG -->
    @if (ShowConfirm && selectedOrder != null)
    {
        <div class="confirm-overlay">
            <div class="confirm-box-large">
                <h3>Xác nhận hủy đơn hàng</h3>
                <p style="margin-bottom: 16px;">
                    Bạn có chắc chắn muốn hủy đơn hàng #@selectedOrder.OrderId?
                    @if (selectedOrder.PayStatus?.ToLower() == "paid")
                    {
                        var paymentMethod = selectedOrder.PaymentMethod?.ToLower();
                        bool isVNPay = paymentMethod == "bank_transfer" || paymentMethod == "vnpay";
                        
                        <br/>
                        @if (isVNPay)
                        {
                            <span style="color: #d97706; font-weight: 500;">
                                ⚠️ Đơn hàng này đã thanh toán qua VNPay, yêu cầu hoàn tiền sẽ được gửi đến Admin để xử lý.
                            </span>
                        }
                        else
                        {
                            <span style="color: #dc2626; font-weight: 500;">
                                ⚠️ Đơn hàng này đã thanh toán, tiền sẽ được hoàn lại.
                            </span>
                        }
                    }
                </p>

                <!-- FORM NHẬP THÔNG TIN HỦY ĐƠN -->
                @if (selectedOrder.PayStatus?.ToLower() == "paid")
                {
                    <div class="cancel-form">
                        <div class="form-group">
                            <label>Lý do hủy đơn <span style="color: red;">*</span></label>
                            <textarea 
                                class="form-control" 
                                rows="3" 
                                placeholder="Vui lòng cho biết lý do hủy đơn hàng..."
                                @bind="cancelReason"
                                maxlength="500"></textarea>
                            <small class="text-muted">@(cancelReason?.Length ?? 0)/500 ký tự</small>
                        </div>

                        <div class="form-group">
                            <label>Tên ngân hàng <span style="color: red;">*</span></label>
                            <input 
                                type="text" 
                                class="form-control" 
                                placeholder="Ví dụ: Vietcombank, BIDV, Techcombank..."
                                @bind="bankName"
                                maxlength="100" />
                        </div>

                        <div class="form-group">
                            <label>Số tài khoản <span style="color: red;">*</span></label>
                            <input 
                                type="text" 
                                class="form-control" 
                                placeholder="Nhập số tài khoản ngân hàng"
                                @bind="bankAccount"
                                maxlength="50" />
                        </div>

                        <div class="form-group">
                            <label>Tên chủ tài khoản <span style="color: red;">*</span></label>
                            <input 
                                type="text" 
                                class="form-control" 
                                placeholder="Nhập tên chủ tài khoản"
                                @bind="accountHolder"
                                maxlength="100" />
                        </div>
                    </div>
                }

                <div class="actions">
                    <button class="btn-yes"
                            disabled="@Canceling"
                            @onclick="DoCancel">
                        @(Canceling ? "Đang hủy..." : "Xác nhận hủy")
                    </button>

                    <button class="btn-no"
                            disabled="@Canceling"
                            @onclick="CloseConfirm">
                        Không hủy
                    </button>
                </div>

                @if (!string.IsNullOrEmpty(CancelError))
                {
                    <div class="error" style="margin-top:8px; color: #dc2626; font-size: 14px;">
                        ❌ @CancelError
                    </div>
                }
                
                @if (!string.IsNullOrEmpty(CancelSuccess))
                {
                    <div class="success" style="margin-top:8px; color: #16a34a; font-size: 14px;">
                        ✅ @CancelSuccess
                    </div>
                }
            </div>
        </div>
    }




</div>

<style>
    /* CSS CHO MODAL HỦY ĐƠN HÀNG */
    .confirm-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.4); z-index:1000; }
    .confirm-box { background:#fff; width:400px; max-width:90%; border-radius:10px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.2); }
    .confirm-box-large { background:#fff; width:600px; max-width:90%; max-height:90vh; overflow-y:auto; border-radius:10px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.2); }
    .confirm-box h3, .confirm-box-large h3 { margin:0 0 8px; }
    .confirm-box .actions, .confirm-box-large .actions { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
    .btn-yes { padding:8px 12px; background:#ef4444; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    .btn-no { padding:8px 12px; background:#e5e7eb; color:#111827; border:none; border-radius:6px; cursor:pointer; }
    
    /* CSS CHO FORM HỦY ĐƠN */
    .cancel-form { margin: 16px 0; }
    .cancel-form .form-group { margin-bottom: 16px; }
    .cancel-form label { display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 14px; }
    .cancel-form .form-control { 
        width: 100%; 
        padding: 10px 12px; 
        border: 2px solid #e5e7eb; 
        border-radius: 8px; 
        font-size: 14px;
        transition: all 0.2s;
        font-family: inherit;
    }
    .cancel-form .form-control:focus { 
        outline: none; 
        border-color: #2ecc71; 
        box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1); 
    }
    .cancel-form textarea.form-control { 
        resize: vertical; 
        min-height: 80px;
    }
    .cancel-form .text-muted { 
        font-size: 12px; 
        color: #6b7280; 
        margin-top: 4px;
        display: block;
    }


    /* BADGE */
    .badge { 
        padding:4px 8px; 
        border-radius:999px; 
        font-size:12px; 
        font-weight:700; 
        text-transform:uppercase; 
    }

    .badge.pending { 
        background:#fff7ed; 
        color:#b45309; 
    }

    .badge.approved { 
        background:#dbeafe; 
        color:#1e40af; 
    }

    .badge.processing { 
        background:#fef3c7; 
        color:#92400e; 
    }

    .badge.shipping { 
        background:#e0e7ff; 
        color:#4338ca; 
    }

    .badge.delivered { 
        background:#dcfce7; 
        color:#166534; 
    }

    .badge.completed,
    .badge.paid { 
        background:#e6fffa; 
        color:#0f766e; 
    }

    .badge.canceled { 
        background:#fee2e2; 
        color:#b91c1c; 
    }

    .badge.refund-pending { 
        background:#fef3c7; 
        color:#d97706; 
    }

    .badge.refund-approved { 
        background:#dbeafe; 
        color:#1d4ed8; 
    }

    .badge.refund-completed { 
        background:#d1fae5; 
        color:#059669; 
    }


    /* CSS CHO ORDER CONTAINER */
    .orders-container {
        max-width: 1000px;
        margin: 0 auto;
    }

    .orders-header {
        margin-bottom: 1rem;
    }

    .orders-header h1 {
        text-align: center;
        color: #2c3e50;
        font-weight: 700;
    }

    .orders-header .filters-section {
        background: white;
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }


    .orders-header .filters-section .search-box {
        position: relative;
        margin-bottom: 1.5rem;
    }

    .orders-header .filters-section .search-box i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #7f8c8d;
        font-size: 1.2rem;
    }

    .orders-header .filters-section .search-box input {
        width: 100%;
        padding: 0.875rem 1rem 0.875rem 3rem;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.2s;
    }

    .orders-header .filters-section .search-box input:focus {
        outline: none;
        border-color: #2ecc71;
        box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
    }

    .orders-header .filters-section .category-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .orders-header .filters-section .filter-btn {
        padding: 0.625rem 1.25rem;
        background: #f8f9fa;
        color: #495057;
        border: 2px solid transparent;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .orders-header .filters-section .filter-btn:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }

    .orders-header .filters-section .filter-btn.active {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        color: white;
        border-color: #27ae60;
    }

    .orders-body .orders-item {
        background: white;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
    }

    .orders-body .orders-item .header {
        display: flex;
        justify-content: space-between;
        padding-bottom: 10px;
        border-bottom: 1px solid #ccc;
    }

    .orders-body .orders-item .header .order-code {
        font-weight: bold;

    }

    .orders-body .orders-item .header .order-status {
        color: #27ae60;
        font-weight: 300;
    }

    .orders-body .orders-item .order-info {
        display: flex;
        gap: 20px;
        padding: 12px 0;
        border-bottom: 1px solid #e9ecef;
        flex-wrap: wrap;
    }

    .orders-body .orders-item .order-info .info-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: #495057;
    }

    .orders-body .orders-item .order-info .info-item i {
        color: #6c757d;
        font-size: 16px;
    }

    .orders-body .orders-item .body {

    }

    .orders-body .orders-item .body .order-item {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        padding-top: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ccc;
    }

    .orders-body .orders-item .body .order-item .item-image {
        height: 80px;
        width: 10%;
        background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .orders-body .orders-item .body .order-item .item-info {
        width: 80%;
        display: flex;
        flex-direction: column;
    }

    .orders-body .orders-item .body .order-item .item-info .title {
        font-size: 20px;
    }

    .orders-body .orders-item .body .order-item .item-info .quantity {
        color: #757575;
    }

    .orders-body .orders-item .body .order-item .item-amount {
        width: 10%;
        color: #27ae60;
        font-weight: 300;
        display: flex;
        justify-content: center;
        align-items: center;
    } 

    .orders-body .orders-item .footer {
        margin-top: 30px;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 20px;
    }

    .orders-body .orders-item .footer .order-total-amount .total-amount {
        color: #27ae60;
        font-size: 20px;
        font-weight: 600;
    }

    .orders-body .orders-item .footer .order-btn {
        display: flex;
        gap: 10px;
        
    }

    .orders-body .orders-item .footer .order-btn button {
        padding: 0.625rem 1.25rem;
        background: #f8f9fa;
        color: #495057;
        border: 2px solid transparent;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }


    .orders-body .orders-item .footer .order-btn .order-btn-cancel {
        background: #27ae60;
        color: white;
    }

    .orders-body .orders-item .footer .order-btn .order-btn-cancel:hover {
        background: #219653;
        transform: translateY(-2px);
    }

    .orders-body .orders-item .footer .order-btn .order-btn-detail {
        border: 1px solid #ccc;
    }

    .orders-body .orders-item .footer .order-btn .order-btn-detail:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }

    .empty-orders {
        background: white;
        border-radius: 20px;
        padding: 4rem 2rem;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .empty-icon {
        font-size: 6rem;
        color: #95a5a6;
        margin-bottom: 1.5rem;
    }

    .empty-orders h3 {
        color: #2c3e50;
        margin-bottom: 1rem;
    }

    .empty-orders p {
        font-size: 1.1rem;
        margin-bottom: 2rem;
    }

    .btn-success {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        border: none;
        padding: 0.875rem 2rem;
        border-radius: 12px;
        font-weight: 600;
    }


    /* CSS CHO PHẦN "XEM THÊM" KHI CÓ NHIỀU ITEM */
    .show-more-btn {
        margin-top: 10px;
        background: none;
        border: none;
        color: #27ae60;
        font-weight: 600;
        cursor: pointer;
        padding: 0;
    }

    .show-more-btn:hover {
        text-decoration: underline;
    }


    /* CSS CHO MODAL XEM CHI TIẾT ĐƠN HÀNG */
    .modal-backdrop-custom {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.4);
        z-index: 999;
    }

    .order-detail-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -45%);
        background: white;
        width: 90%;
        max-height: 80%;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        z-index: 1000;
        padding: 20px;
        animation: fadeIn 0.2s ease-in-out;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .modal-body {
        margin-top: 15px;
        
    }

    .modal-body .modal-info-detail {
        background: #fffcf5;
        padding: 10px;
    }

    .modal-body .modal-info-detail .detail {
        padding: 50px 200px;
        display: flex;
        flex-direction: column;
        font-size: 15px;
        justify-content: space-around;
    }

    .modal-body .modal-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
        font-size: 14px;
    }

    .modal-body .modal-table thead {
        background: #f5f5f5;
    }

    .modal-body .modal-table th {
        padding: 10px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #ddd;
        color: #333;
    }

    .modal-body .modal-table td {
        padding: 10px;
        border-bottom: 1px dashed #e0e0e0;
        color: #444;
    }

    .modal-body .modal-table th:first-child,
    .modal-body .modal-table td:first-child {
        text-align: center;
        width: 50px;
        font-weight: 500;
    }

    .modal-body .modal-table th:nth-child(3),
    .modal-body .modal-table td:nth-child(3) {
        text-align: center;
        width: 100px;
    }

    .modal-body .modal-table th:nth-child(4),
    .modal-body .modal-table td:nth-child(4) {
        text-align: center;
        width: 100px;
    }

    .modal-body .modal-table th:nth-child(5),
    .modal-body .modal-table td:nth-child(5) {
        text-align: right;
        width: 140px;
        font-weight: 500;
        color: #27ae60;
    }

    .modal-body .modal-table tbody tr:hover {
        background: #f9f9f9;
    }

    .modal-body .modal-final-amount {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .modal-body .modal-final-amount .detail-amount {
        display: flex;
        flex-direction: column;
    }

    .modal-footer {
        padding-top: 20px;
        border-top: 1px solid #757575;
        margin-top: 30px;
        display: flex;
        flex-direction: row;
        justify-content: flex-end;
        align-items: center;
        gap: 10px;
    }

    
    .order-btn-detail {
        padding: 0.625rem 1.25rem;
        background: #f8f9fa;
        color: #495057;
        border: 2px solid transparent;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #757575;
    }

    .order-btn-detail:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }

    .order-btn-pdf {
        padding: 0.625rem 1.25rem;
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .order-btn-pdf:hover:not(:disabled) {
        background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }

    .order-btn-pdf:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .order-btn-pdf i {
        font-size: 16px;
    }

    /* CUSTOM VIỀN */
    .airmail-border {
        position: relative;
        padding-bottom: 16px;
    }

    .airmail-border::after {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 4px; 

        background: repeating-linear-gradient(
            90deg,
            #4a90e2 0px,
            #4a90e2 28px,
            transparent 28px,
            transparent 40px,
            #f56a79 40px,
            #f56a79 68px,
            transparent 68px,
            transparent 80px
        );

        pointer-events: none;
    }


    @@keyframes fadeIn {
        from { opacity: 0; transform: translate(-50%, -55%); }
        to { opacity: 1; transform: translate(-50%, -50%); }
    }

</style>

@code {
    // LOGIC MAIN
    private List<OrderWithDetailsDto> orders = new();
    private List<OrderWithDetailsDto> filteredOrders = new();
    private List<OrderWithDetailsDto> paginatedOrders = new();
    private Dictionary<int, string> productImageUrls = new();
    private bool isLoading = true;
    private string? selectedCategoryName = null;
    private string searchKeyword = "";
    private System.Threading.Timer? searchTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var ordersDto = await OrderService.GetOnlineOrdersByCustomerIdAsync();
            orders = ordersDto.Select(o => new OrderWithDetailsDto
            {
                OrderId = o.OrderId,
                CustomerId = o.CustomerId,
                UserId = o.UserId,
                PromoId = o.PromoId,
                OrderDate = o.OrderDate,
                PayStatus = o.PayStatus,
                OrderStatus = o.OrderStatus,
                TotalAmount = o.TotalAmount,
                DiscountAmount = o.DiscountAmount,
                OrderType = o.OrderType,
                PaymentMethod = o.PaymentMethod,
                Name = o.Name,
                Address = o.Address,
                Phone = o.Phone,
                Email = o.Email,
                OrderItems = new List<OrderItemWithProductDto>()
            }).ToList();
            
            foreach (var order in orders)
            {
                // Gắn chi tiết sản phẩm vào order theo order_id
                order.OrderItems = (await OrderService
                    .GetOrderItemWithProductAsync(order.OrderId))
                    .ToList();
                
                // Preload S3 images for order items
                foreach (var item in order.OrderItems)
                {
                    if (item.ProductId.HasValue && !productImageUrls.ContainsKey(item.ProductId.Value))
                    {
                        if (!string.IsNullOrEmpty(item.ImageUrl))
                        {
                            var imageUrl = await S3ImageService.GetImageUrlAsync(item.ImageUrl);
                            productImageUrls[item.ProductId.Value] = imageUrl;
                        }
                    }
                }
                
                // Kiểm tra refund request cho đơn hàng đã hủy
                if (order.OrderStatus?.ToLower() == "canceled")
                {
                    var paymentMethod = order.PaymentMethod?.ToLower();
                    bool isVNPay = paymentMethod == "bank_transfer" || paymentMethod == "vnpay";
                    
                    // Chỉ kiểm tra refund cho đơn VNPAY hoặc đơn có pay_status = pending (đang chờ xử lý)
                    if (isVNPay || order.PayStatus?.ToLower() == "pending")
                    {
                        try
                        {
                            var refunds = await OrderService.GetRefundRequestsByOrderIdAsync(order.OrderId);
                            var pendingRefund = refunds.FirstOrDefault(r => r.Status?.ToLower() == "pending");
                            
                            if (pendingRefund != null)
                            {
                                order.HasPendingRefund = true;
                                order.RefundStatus = "pending";
                            }
                            else
                            {
                                var approvedRefund = refunds.FirstOrDefault(r => r.Status?.ToLower() == "approved");
                                if (approvedRefund != null)
                                {
                                    order.HasPendingRefund = true;
                                    order.RefundStatus = "approved";
                                }
                                else
                                {
                                    var completedRefund = refunds.FirstOrDefault(r => r.Status?.ToLower() == "completed");
                                    if (completedRefund != null)
                                    {
                                        order.RefundStatus = "completed";
                                    }
                                }
                            }
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"Error loading refund for order {order.OrderId}: {ex.Message}");
                        }
                    }
                }
            }
            filteredOrders = orders;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading orders: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void FilterByCategory(string? categoryName)
    {
        selectedCategoryName = categoryName;
        ApplyFilters();
    }

    private void OnSearchKeyup()
    {
        searchTimer?.Dispose();
        searchTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                ApplyFilters();
                StateHasChanged();
            });
        }, null, 300, Timeout.Infinite);
    }

    private void ApplyFilters()
    {
        filteredOrders = orders;
        

        // Filter by category name (OrderStatus)
        if (!string.IsNullOrEmpty(selectedCategoryName))
        {
            if (selectedCategoryName == "refund")
            {
                // Lọc các đơn đang chờ hoàn tiền
                filteredOrders = filteredOrders
                    .Where(o => o.HasPendingRefund || o.RefundStatus == "pending" || o.RefundStatus == "approved")
                    .ToList();
            }
            else
            {
                filteredOrders = filteredOrders
                    .Where(o => o.OrderStatus?.ToLower() == selectedCategoryName.ToLower())
                    .ToList();
            }
        }

        // Filter by search keyword
        if (!string.IsNullOrWhiteSpace(searchKeyword))
        {
            var keyword = searchKeyword.ToLower();
            filteredOrders = filteredOrders
                .Where(o => 
                    (int.TryParse(keyword, out int id) && o.OrderId == id) ||
                    (o.PayStatus?.ToLower().Contains(keyword) ?? false) ||
                    (o.OrderStatus?.ToLower().Contains(keyword) ?? false)
                )
                .ToList();
        }

    }

    // LOGIC "XEM THÊM" KHI CÓ NHIỀU ITEM 
    private Dictionary<int, bool> expandOrderItems = new();

    private void ToggleExpand(int orderId)
    {
        if (expandOrderItems.ContainsKey(orderId))
        {
            expandOrderItems[orderId] = !expandOrderItems[orderId];
        }
        else
        {
            expandOrderItems.Add(orderId, true);
        }
    }


    // LOGIC CHO MODAL XEM CHI TIẾT ĐƠN HÀNG
    private bool isShowDetailModal = false;
    private OrderWithDetailsDto? selectedOrder = null;
    private bool isDownloadingPdf = false;

    private void OpenOrderDetail(OrderWithDetailsDto order)
    {
        selectedOrder = order;
        isShowDetailModal = true;
    }

    private void CloseOrderDetail()
    {
        isShowDetailModal = false;
        selectedOrder = null;
    }

    private async Task DownloadPdf(int orderId)
    {
        isDownloadingPdf = true;
        StateHasChanged();

        try
        {
            var response = await OrderService.DownloadInvoicePdfAsync(orderId);
            if (response != null && response.Length > 0)
            {
                var fileName = $"HoaDon_{orderId}_{DateTime.Now:yyyyMMdd}.pdf";
                var base64 = Convert.ToBase64String(response);
                
                // Tải file PDF sử dụng JavaScript
                await JSRuntime.InvokeVoidAsync("downloadFileFromBytes", fileName, base64);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading PDF: {ex.Message}");
        }
        finally
        {
            isDownloadingPdf = false;
            StateHasChanged();
        }
    }

    // LOGIC CHO MODAL HỦY ĐƠN HÀNG
    private bool ShowConfirm = false;
    private bool Canceling = false;
    private string? CancelError;
    private string? CancelSuccess;
    
    // Form data cho hủy đơn
    private string? cancelReason;
    private string? bankName;
    private string? bankAccount;
    private string? accountHolder;

    private async Task DoCancel()
    {
        Canceling = true;
        CancelError = null;
        CancelSuccess = null;
        StateHasChanged();

        try
        {
            if(selectedOrder == null)
            {
                CancelError = "Không tìm thấy đơn hàng!";
                return;
            }

            // Kiểm tra điều kiện hủy đơn
            if(selectedOrder.OrderType?.ToLower() != "online")
            {
                CancelError = "Chỉ có thể hủy đơn hàng online!";
                return;
            }

            var nonCancelableStatuses = new[] { "approved", "processing", "shipping", "delivered", "completed" };
            if(nonCancelableStatuses.Contains(selectedOrder.OrderStatus?.ToLower()))
            {
                CancelError = "Không thể hủy đơn hàng đã được xử lý!";
                return;
            }
            
            // Validate form nếu đơn đã thanh toán
            if (selectedOrder.PayStatus?.ToLower() == "paid")
            {
                if (string.IsNullOrWhiteSpace(cancelReason))
                {
                    CancelError = "Vui lòng nhập lý do hủy đơn!";
                    return;
                }
                
                if (string.IsNullOrWhiteSpace(bankName))
                {
                    CancelError = "Vui lòng nhập tên ngân hàng!";
                    return;
                }
                
                if (string.IsNullOrWhiteSpace(bankAccount))
                {
                    CancelError = "Vui lòng nhập số tài khoản!";
                    return;
                }
                
                if (string.IsNullOrWhiteSpace(accountHolder))
                {
                    CancelError = "Vui lòng nhập tên chủ tài khoản!";
                    return;
                }
            }
            
            // Tạo DTO với thông tin hủy đơn
            var cancelDto = new CancelOrderDto
            {
                Reason = cancelReason,
                CustomerBankName = bankName,
                CustomerBankAccount = bankAccount,
                CustomerAccountHolder = accountHolder
            };
            
            // Gọi API hủy đơn
            var result = await OrderService.CancelOrderAsync(selectedOrder.OrderId, cancelDto);
            
            if(result)
            {
                CancelSuccess = "Đơn hàng đã được hủy thành công!";
                
                // Đợi 1.5 giây để hiển thị thông báo thành công
                await Task.Delay(1500);
                
                // Reload data và đóng modal
                await LoadData();
                ShowConfirm = false;
                CancelSuccess = null;
                
                // Reset form
                ResetCancelForm();
            }
            else
            {
                CancelError = "Hủy đơn hàng thất bại. Vui lòng thử lại!";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error canceling order: {ex.Message}");
            CancelError = $"Lỗi: {ex.Message}";
        }
        finally
        {
            Canceling = false;
            StateHasChanged();
        }
    }

    private void CloseConfirm()
    {
        ShowConfirm = false;
        CancelError = null;
        CancelSuccess = null;
        ResetCancelForm();
    }

    public void OpenConfirm(OrderWithDetailsDto order)
    {
        selectedOrder = order;
        CancelError = null;
        CancelSuccess = null;
        ShowConfirm = true;
        ResetCancelForm();
    }
    
    private void ResetCancelForm()
    {
        cancelReason = null;
        bankName = null;
        bankAccount = null;
        accountHolder = null;
    }
}
