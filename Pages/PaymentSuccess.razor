@page "/payment-success/{OrderId:int}"
@layout CustomerLayout
@using BlazorApp.Dto
@using BlazorApp.Services
@using Microsoft.JSInterop
@inject IOrderService OrderService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<PageTitle>Thanh toán thành công</PageTitle>

<div class="container my-4" style="max-width: 800px;">
    @if (isLoading)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-success" role="status"></div>
        </div>
    }
    else if (order == null)
    {
        <div class="alert alert-warning">
            Không tìm thấy đơn hàng.
        </div>
    }
    else
    {
        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-body p-4 p-md-5 text-center">
                <!-- Success Icon -->
                <div class="mb-4 success-icon-animate">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
                </div>
                
                <!-- Success Message -->
                <h1 class="text-success fw-bold mb-3" style="font-size: 2.5rem;">Đặt hàng thành công!</h1>
                <p class="text-muted fs-5 mb-4">Cảm ơn bạn đã mua hàng tại Store Manager</p>
                
                <!-- Order Info -->
                <div class="bg-light rounded-3 p-4 mb-4 text-start">
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted fw-medium">Mã đơn hàng:</span>
                        <span class="fw-semibold text-dark">#@order.OrderId</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted fw-medium">Ngày đặt:</span>
                        <span class="fw-semibold text-dark">@order.OrderDate.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted fw-medium">Tổng tiền:</span>
                        <span class="fw-bold text-success fs-4">@finalAmount.ToString("N0") đ</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span class="text-muted fw-medium">Trạng thái:</span>
                        <span class="badge bg-success fs-6">@order.Status</span>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="mb-4 text-start">
                    <h3 class="text-dark mb-3 fs-4">Chi tiết đơn hàng</h3>
                    <div class="bg-light rounded-3 p-3">
                        @foreach (var item in order.OrderItems)
                        {
                            <div class="bg-white rounded-3 p-3 mb-2 d-flex justify-content-between align-items-center">
                                <div class="d-flex flex-column">
                                    <span class="fw-semibold text-dark">@(item.ProductName ?? "Sản phẩm")</span>
                                    <span class="text-muted small">x @item.Quantity</span>
                                </div>
                                <span class="fw-semibold text-success fs-5">@((item.Price * item.Quantity).ToString("N0")) đ</span>
                            </div>
                        }
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex flex-column flex-md-row gap-2 justify-content-center mt-4">
                    <button class="btn btn-success btn-lg px-4" @onclick="DownloadInvoice" disabled="@isDownloading">
                        @if (isDownloading)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>Đang tải...</span>
                        }
                        else
                        {
                            <i class="bi bi-file-earmark-pdf me-2"></i>
                            <span>Tải hóa đơn PDF</span>
                        }
                    </button>
                    
                    <a href="/products" class="btn btn-primary btn-lg px-4">
                        <i class="bi bi-shop me-2"></i>
                        Tiếp tục mua sắm
                    </a>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int OrderId { get; set; }

    private OrderDto? order;
    private bool isLoading = true;
    private bool isDownloading = false;
    private decimal finalAmount = 0;
    private int customerId;

    protected override async Task OnInitializedAsync()
    {
        var user = await AuthService.GetCurrentUserAsync();
        if (user != null)
        {
            customerId = user.CustomerId;
            await LoadOrder();
        }
        else
        {
            Navigation.NavigateTo("/login");
        }
    }

    private async Task LoadOrder()
    {
        isLoading = true;
        try
        {
            // Fetch order details
            var response = await Http.GetAsync($"api/customer/orders/{OrderId}");
            if (response.IsSuccessStatusCode)
            {
                order = await response.Content.ReadFromJsonAsync<OrderDto>();
                if (order != null)
                {
                    finalAmount = order.TotalAmount - order.DiscountAmount;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading order: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task DownloadInvoice()
    {
        isDownloading = true;
        try
        {
            // Call API to download PDF
            var response = await Http.GetAsync($"api/customer/orders/{OrderId}/invoice-pdf");
            if (response.IsSuccessStatusCode)
            {
                var fileBytes = await response.Content.ReadAsByteArrayAsync();
                var fileName = $"HoaDon_{OrderId}_{DateTime.Now:yyyyMMdd}.pdf";
                
                // Download file using JavaScript
                var base64 = Convert.ToBase64String(fileBytes);
                await JSRuntime.InvokeVoidAsync("downloadFileFromBytes", fileName, base64);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading invoice: {ex.Message}");
        }
        finally
        {
            isDownloading = false;
        }
    }
}
