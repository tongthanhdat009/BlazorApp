@using System.Timers
@using BlazorApp.Services
@inject IToastService ToastService
@implements IDisposable

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    @foreach (var toast in toasts)
    {
        <div class="toast show border-0 shadow-lg position-relative" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header @GetHeaderClass(toast.Type)">
                <i class="@GetIcon(toast.Type) me-2"></i>
                <strong class="me-auto text-white">@toast.Title</strong>
                <small class="text-white-50">Vừa xong</small>
                <button type="button" class="btn-close btn-close-white" @onclick="() => RemoveToast(toast)"></button>
            </div>
            <div class="toast-body bg-white">
                @toast.Message
            </div>
            <div class="toast-progress-container">
                <div class="toast-progress @GetProgressClass(toast.Type)" style="width: @toast.Progress%;"></div>
            </div>
        </div>
    }
</div>

<style>
    .toast {
        min-width: 320px;
        border-radius: 12px;
        overflow: hidden;
        animation: slideIn 0.3s ease-out;
    }

    @@keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .toast.hiding {
        animation: slideOut 0.3s ease-in forwards;
    }

    @@keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    .toast-header.success {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        color: white;
    }

    .toast-header.error {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
    }

    .toast-header.warning {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        color: white;
    }

    .toast-header.info {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
    }

    .toast-progress-container {
        width: 100%;
        height: 4px;
        background-color: #e9ecef;
    }

    .toast-progress {
        height: 100%;
        transition: width 0.1s linear;
    }

    .toast-progress.success {
        background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
    }

    .toast-progress.error {
        background: linear-gradient(90deg, #c0392b 0%, #e74c3c 100%);
    }

    .toast-progress.warning {
        background: linear-gradient(90deg, #e67e22 0%, #f39c12 100%);
    }

    .toast-progress.info {
        background: linear-gradient(90deg, #2980b9 0%, #3498db 100%);
    }

    .toast-body {
        font-size: 0.95rem;
        padding: 0.75rem 1rem;
    }
</style>

@code {
    private List<ToastItem> toasts = new();

    protected override void OnInitialized()
    {
        ToastService.OnShow += HandleShow;
    }

    private void HandleShow(string message, string title, ToastType type)
    {
        ShowToast(title, message, type);
    }

    public void ShowSuccess(string message, string title = "Thành công")
    {
        ShowToast(title, message, ToastType.Success);
    }

    public void ShowError(string message, string title = "Lỗi")
    {
        ShowToast(title, message, ToastType.Error);
    }

    public void ShowWarning(string message, string title = "Cảnh báo")
    {
        ShowToast(title, message, ToastType.Warning);
    }

    public void ShowInfo(string message, string title = "Thông báo")
    {
        ShowToast(title, message, ToastType.Info);
    }

    private void ShowToast(string title, string message, ToastType type)
    {
        var toast = new ToastItem
        {
            Id = Guid.NewGuid(),
            Title = title,
            Message = message,
            Type = type,
            Progress = 100
        };

        toasts.Add(toast);
        InvokeAsync(StateHasChanged);

        // Start progress countdown (4 seconds = 4000ms)
        StartProgressTimer(toast);
    }

    private void StartProgressTimer(ToastItem toast)
    {
        var totalDuration = 4000; // 4 seconds
        var interval = 40; // Update every 40ms for smooth animation
        var decrementPerTick = 100.0 / (totalDuration / interval);
        
        var timer = new Timer(interval);
        timer.Elapsed += (sender, e) =>
        {
            InvokeAsync(() =>
            {
                toast.Progress -= decrementPerTick;
                if (toast.Progress <= 0)
                {
                    timer.Stop();
                    timer.Dispose();
                    RemoveToast(toast);
                }
                StateHasChanged();
            });
        };
        timer.Start();
    }

    private void RemoveToast(ToastItem toast)
    {
        toasts.Remove(toast);
        StateHasChanged();
    }

    private string GetHeaderClass(ToastType type) => type switch
    {
        ToastType.Success => "success",
        ToastType.Error => "error",
        ToastType.Warning => "warning",
        ToastType.Info => "info",
        _ => "info"
    };

    private string GetProgressClass(ToastType type) => type switch
    {
        ToastType.Success => "success",
        ToastType.Error => "error",
        ToastType.Warning => "warning",
        ToastType.Info => "info",
        _ => "info"
    };

    private string GetIcon(ToastType type) => type switch
    {
        ToastType.Success => "bi bi-check-circle-fill",
        ToastType.Error => "bi bi-x-circle-fill",
        ToastType.Warning => "bi bi-exclamation-triangle-fill",
        ToastType.Info => "bi bi-info-circle-fill",
        _ => "bi bi-info-circle-fill"
    };

    public void Dispose()
    {
        ToastService.OnShow -= HandleShow;
    }

    private class ToastItem
    {
        public Guid Id { get; set; }
        public string Title { get; set; } = "";
        public string Message { get; set; } = "";
        public ToastType Type { get; set; }
        public double Progress { get; set; } = 100;
    }
}
